<!DOCTYPE html>
<html>
<head>
  <title>Bother - Bot Making IDE: Tracery</title>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script defer src="js/tracery.js"></script>
  <script defer src="js/clipboard.min.js"></script>

  <script src="js/jquery-1.11.2.min.js"></script>

  <script src="js/handsontable/dist/handsontable.full.js"></script>

  <link rel="stylesheet" media="screen" href="css/bootstrap.css">
  <link rel="stylesheet" media="screen" href="css/bootstrap-theme.css">

  <link rel="stylesheet" media="screen" href="js/handsontable/dist/handsontable.full.css">

  <!-- Custom CSS for this example -->
  <style type="text/css">
  /*  .example {
      width: 940px;
      margin: 50px auto;
      padding: 0 20px;
    }
*/
/*    .sensei-grid {
      margin-bottom: 20px;
    }
*/
    h1 {
      font-weight: bold;
      line-height: normal;
    }

    #container {
      width: 800px;
      margin: 0 auto;
    }

    textarea{ 
      width: 100%;
    }
    #templateExplain {
      font-style: italic;
      color: #999;
    }
    th {
      background-color: #eee;
    }
  </style>

  <script>
  Array.prototype.clean = function(deleteValue) {
  for (var i = 0; i < this.length; i++) {
    if (this[i] == deleteValue) {         
      this.splice(i, 1);
      i--;
    }
  }
  return this;
  };

  Array.prototype.allEmpty = function(){
    result = true;
    for(var i = 0; i < this.length; i++){
      if(this[i]){
        result = false;
      } else {
        result = true && result;
      }
    }
    return result;
  }

  function getTraceryData(){
    result = {};
    for(var i = 0; i < colHeadings.length; i++){
        result[colHeadings[i]] = hot.getDataAtCol(i).clean();
    }
    
    result.origin = $("#template textarea").val();
    return result;
  }

  function updateTracery(){
    try{
      var grammar = tracery.createGrammar(getTraceryData());
      $("#output").html(grammar.flatten("#origin#"));
      $("#traceryData").html(JSON.stringify(getTraceryData()));
      $("#templateExplain").html("<b>Avaible tags:</b> #" + colHeadings.join("# #") + "#");

      $("#template textarea").css("background-color", "#fff");

    } catch(err){
      console.log(err);
      $("#template textarea").css("background-color", "#fee");
    }
  }
  var hot;
  var colHeadings;
  $(document).ready(function(){

      var origData = {"weather":["rain","snow","sleet","frogs","plagues"],"country":["Spain","England"],"verb":["falls","appears","burns"],"adjective":["mainly","primarily","occassionally"],"geographical location":["plain","imagination"]};

      colHeadings = Object.keys(origData);

      var longestCol = 0;
      for(key in origData){
        if(origData[key].length > longestCol){
          longestCol = origData[key].length;
        }
      }
      var result = [];
      for(var i = 0; i < longestCol; i++){
        row = [];
        for(key in origData){
          row.push(origData[key][i]);
        }
        result.push(row);
      }
      result.push([]);
      

  
      var container = document.getElementById('grid');
      hot = new Handsontable(container,{
        data: result,
        contextMenu: ["col_right", "remove_col"],
        allowInsertColumn : true,
        allowRemoveColumn : true,
        colHeaders : colHeadings,
        colHeaders: function (index) {
            var textbox = '<input type="text" value="' + colHeadings[index] + '" />';
            return textbox;
        },
        afterOnCellMouseDown: function (sender, e) {
            if (e.row === -1) {

                colHeadings[e.col] = $(sender.realTarget).val();
                this.getInstance().deselectCell();
                $("#grid").handsontable('updateSettings', {'colHeaders': colHeadings});
            }
        },
         manualColumnMove: true,
         manualColumnResize: true,
        afterChange : function(){
          if(!this.getSourceData()[this.getSourceData().length - 1].allEmpty()){
            this.alter("insert_row",this.getSourceData().length);
          } 
          if(hot){
            updateTracery();
          }
         

        },
        afterRemoveCol :function(index, amount){
          console.log("remove column: " + index + " columns: " + amount);
          colHeadings.splice(index, amount);
          console.log(colHeadings);
        }
       });

      $("#refresh").click(function(e){
        e.preventDefault();
        updateTracery();
      });
    });

  </script>

</head>
<body>
<div class="container">
    <div id="template">
      <h2>Write your template</h2>
      <p id="templateExplain"></p>
      <textarea>The #weather# in #country# #verb# #adjective# in the #geographical location#.</textarea>
      <p><em>(Learn all about <a target="_" href="http://www.crystalcodepalace.com/traceryTut.html">Tracery</a>.)</em></p>
      <h3>Output</h3>
      <p id="output"></p> (<a id="refresh" href="#">refresh</a>)
    </div>
    <div id="data">
      <h2>Enter Your Bot Data</h2>
      <p><em>Right-click to add or remove columns. Click the header to rename. Drag the header to expand or move columns.</em></p>
      <div id="grid"></div>
    </div>
    <div id="tracery">
      <h3>
        Tracery Data
      </h3>
      <p>Paste this into <a href="http://cheapbotsdonequick.com/">Cheap Bots Done Quick!</a> to deploy your bot.</p>
      <button class="btn" data-clipboard-action="copy" data-clipboard-target="#traceryData">Copy</button>

      <textarea id="traceryData"></textarea>
    </div>
</div>

</body>
</html>
